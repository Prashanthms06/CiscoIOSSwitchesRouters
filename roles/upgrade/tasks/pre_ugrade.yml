---
- include_tasks: collect_device_information.yml
  vars:
    - task: "PreUpgrade"
    - flash_var_name: "pre_disk_space"
    - version_var_name: "old_version"
    - interface_var_name: "pre_interface_list"
    - cdp_var_name: "pre_cdp"
    - ether_var_name: "pre_ether_summary"
    - bgp_var_name: "pre_bgp_summary"
    - layer3_var_name: "pre_layer3_summary"
    - vrf_var_name: "pre_vrf_int_summary"
    - run_cfg_var_name: "pre_run_cfg"
    - bgp_vrf_var_name: "pre_bgp_vrf_summary"
    - ospf_var_name: "pre_ospf_summary"
    - fs_var_name: "pre_fs_info"
#
#
#
#Compare the older version as well and fail if they are not matching
- fail:
    msg: "The older firmware version {{ old_fw_version }} provided doesn't match with the system's firmware version {{ old_version.version }}"
  when: not old_fw_version==old_version.version

- fail:
   msg: "Device doesn't have enough space to upload the file. Size of the file {{ upgrade_file_info.stat.size }} and available bytes {{ pre_disk_space[0].flash_size.available_bytes }} "
  when: upgrade_file_info.stat.size|int > pre_disk_space[0].flash_size.available_bytes|int

- debug:
   msg: "Enabling the scp"

- ios_command:
    commands:
      - "conf t"
      - "ip scp server enable"

- debug:
    msg: "Copying the file {{ upgraded_fw_name }} to the device"

- name: "Copying {{ upgraded_fw_name }} to device"
  command: "sshpass -p {{ ansible_ssh_pass }} scp {{ ios_fw_folder }}/{{ upgraded_fw_name }} {{ ansible_ssh_user }}@{{ inventory_hostname }}:flash:{{ upgraded_fw_name }}"
  async: 3600
  poll: 0
  register: copy_sleeper
#
- name: 'Check if the firmware file {{ upgraded_fw_name }} is completed. '
  async_status:
    jid: "{{ copy_sleeper.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 3600
  delay: 60

- debug:
   msg: "Disabling the scp"

- ios_command:
    commands:
      - "conf t"
      - "no ip scp server enable"

- debug:
    msg: "Verifying the MD5 hash"